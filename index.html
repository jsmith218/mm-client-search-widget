<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: Arial, sans-serif; padding: 10px; }
  input { width: 100%; padding: 10px; margin: 6px 0; font-size: 16px; }
  .result { border: 1px solid #ddd; padding: 10px; margin: 6px 0; border-radius: 8px; }
  .result:hover { background: #f2f2f2; }
  .hint { font-size: 12px; opacity: .7; margin: 6px 0 10px; }
  .error { border: 1px solid #f3b; background: #fff5f8; }
</style>
</head>
<body>

<input id="id" placeholder="Client ID (optional)">
<input id="last" placeholder="Last name">
<input id="first" placeholder="First name (optional)">
<div class="hint" id="status">Type at least 2 letters of last name (or an ID).</div>

<div id="results"></div>

<script>
// ===== JSONP helper (works inside Jotform iframe; avoids CORS) =====
function jsonp(url) {
  return new Promise((resolve, reject) => {
    const cbName = "cb_" + Math.random().toString(36).slice(2);

    window[cbName] = (data) => {
      try { delete window[cbName]; } catch(e) {}
      script.remove();
      resolve(data);
    };

    const script = document.createElement("script");
    script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cbName;
    script.onerror = () => {
      try { delete window[cbName]; } catch(e) {}
      script.remove();
      reject(new Error("JSONP request failed"));
    };

    document.body.appendChild(script);
  });
}

// ===== Set your Apps Script endpoint here =====
const ENDPOINT = "https://script.google.com/macros/s/AKfycbyHOJj1wvNzz4z4OhjxpUBIQDhr3KDKE4tug6jUemZSNIlkYximRfcP2sg5GxCF5J5a/exec";

let t = null;

// Warm-up ping to reduce Apps Script cold-start pain
jsonp(`${ENDPOINT}?id=zzzzzzzz&limit=1`).catch(()=>{});

document.getElementById("id").addEventListener("input", scheduleSearch);
document.getElementById("last").addEventListener("input", scheduleSearch);
document.getElementById("first").addEventListener("input", scheduleSearch);

function scheduleSearch() {
  clearTimeout(t);
  t = setTimeout(runSearch, 450); // debounce
}

async function runSearch() {
  const id = document.getElementById("id").value.trim();
  const last = document.getElementById("last").value.trim();
  const first = document.getElementById("first").value.trim();

  const resultsEl = document.getElementById("results");
  const statusEl = document.getElementById("status");

  // require at least 2 chars of last name unless ID is present
  if (!id && last.length < 2) {
    resultsEl.innerHTML = "";
    statusEl.textContent = "Type at least 2 letters of last name (or an ID).";
    return;
  }

  statusEl.textContent = "Searchingâ€¦";

  const url =
    `${ENDPOINT}?id=${encodeURIComponent(id)}&last=${encodeURIComponent(last)}&first=${encodeURIComponent(first)}&limit=25`;

  try {
    const data = await jsonp(url);

    if (!data.ok) {
      resultsEl.innerHTML = `<div class="result error"><b>Error:</b> ${escapeHtml(data.error || "Unknown error")}</div>`;
      statusEl.textContent = "Search error";
      return;
    }

    const results = data.results || [];
    statusEl.textContent = results.length ? `${results.length} match(es)` : "No matches";

    render(results);

  } catch (err) {
    resultsEl.innerHTML = `<div class="result error"><b>Error:</b> ${escapeHtml(String(err.message || err))}</div>`;
    statusEl.textContent = "Search failed";
  }
}

function render(results) {
  const resultsEl = document.getElementById("results");
  resultsEl.innerHTML = "";

  results.forEach(r => {
    const div = document.createElement("div");
    div.className = "result";
    div.style.cursor = "pointer";

    div.innerHTML = `
      <b>${escapeHtml(r.last || "")}, ${escapeHtml(r.first || "")}</b><br>
      <b>ID:</b> ${escapeHtml(r.id || "")}<br>
      <b># in family:</b> ${escapeHtml(r["# in family"] || "")}<br>
      <b>Address:</b> ${escapeHtml(r.address || "")}<br>
      <b>End:</b> ${escapeHtml(r.end || "")}
    `;

    div.onclick = () => {

  const FORM_URL = "https://form.jotform.com/260394523652054";

  const params = new URLSearchParams();

  params.set("client_id", r.id || "");
  params.set("first_name", r.first || "");
  params.set("last_name", r.last || "");
  params.set("family_size", r["# in family"] || "");
  params.set("address", r.address || "");
  params.set("start_date", r.start || "");
  params.set("end_date", r.end || "");

  // Redirect entire Jotform app
  window.top.location.href = FORM_URL + "?" + params.toString();
};


    resultsEl.appendChild(div);
  });
}

function escapeHtml(s) {
  return String(s || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}
</script>

</body>
</html>
